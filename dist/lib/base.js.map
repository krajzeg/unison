{"version":3,"sources":["base.js"],"names":[],"mappings":"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","file":"base.js","sourcesContent":["let _ = require('lodash');\r\n\r\n\r\nexport default class Unison {\r\n  constructor(initialState = {}) {\r\n    this._state = initialState;\r\n    this._nextId = 1;\r\n\r\n    this._events = new UnisonEvents();\r\n  }\r\n\r\n  grab(path) {\r\n    return new UnisonNode(this, path)\r\n  }\r\n\r\n  listen(...args) { return this._events.listen.apply(this._events, args); }\r\n  unlisten(...args) { return this._events.unlisten.apply(this._events, args); }\r\n\r\n  collectEvents(path, directEvent, childEvent, acc = []) {\r\n    let parent = parentPath(path), id = idFromPath(path);\r\n    let object = _.get(this._state, path);\r\n\r\n    acc.push([parent, childEvent, id]);\r\n    acc.push([object, directEvent]);\r\n\r\n    _.each(object, (key, value) => {\r\n      if (typeof value === 'object' && !(value instanceof Array)) {\r\n        // that's a child, trigger childAdded and recurse into it\r\n        this.collectEvents(childPath, directEvent, childEvent, acc);\r\n      }\r\n    });\r\n  }\r\n\r\n  nextId() {\r\n    return this._nextId++;\r\n  }\r\n}\r\n\r\nclass UnisonEvents {\r\n  constructor() {\r\n    this._listeners = {};\r\n  }\r\n\r\n  key(path, event) {\r\n    return `${path}:${event}`;\r\n  }\r\n\r\n  listen(path, event, callback) {\r\n    let key = this.key(path, event);\r\n    let existingListeners = [];\r\n    this._listeners[key] = existingListeners.concat([callback]);\r\n  }\r\n\r\n  unlisten(path, event, callback) {\r\n    let key = this.key(path, event);\r\n    let listeners  = (this._listeners[key] || []).filter((cb) => cb != callback);\r\n    if (listeners.length == 0) {\r\n      delete this._listeners[key];\r\n    } else {\r\n      this._listeners[key] = listeners;\r\n    }\r\n  }\r\n\r\n  trigger(path, event, ...payload) {\r\n    let key = this.key(path, event);\r\n    let listeners = this._listeners[key] || [];\r\n    listeners.map((listener) => {\r\n      try {\r\n        listener.apply(null, payload);\r\n      } catch (e) {\r\n        console.error(`Error in listener in response to ${path}|${event}`);\r\n        console.error(e.stack || e);\r\n      }\r\n    });\r\n  }\r\n\r\n  triggerAll(events) {\r\n    _.each(events, (event) => {\r\n      this.trigger.apply(event);\r\n    });\r\n  }\r\n}\r\n\r\nclass UnisonNode {\r\n  constructor(unison, path) {\r\n    this._unison = unison;\r\n    this._path = path;\r\n  }\r\n\r\n  path() {\r\n    return this._path;\r\n  }\r\n\r\n  id() {\r\n    return idFromPath(this.path());\r\n  }\r\n\r\n  parent() {\r\n    return this._unison.grab(parentPath(this.path()));\r\n  }\r\n\r\n  state() {\r\n    if (this._path === '') {\r\n      return this._unison._state;\r\n    } else {\r\n      return _.get(this._unison._state, this._path);\r\n    }\r\n  }\r\n\r\n  update(props) {\r\n    var state = this.state();\r\n    if (state === undefined) return;\r\n\r\n    _.extend(state, props);\r\n    this._unison._events.trigger(this._path, 'updated');\r\n  }\r\n\r\n  add(...args) {\r\n    let unison = this._unison;\r\n\r\n    // extract arguments (either (child) or (id, child))\r\n    let id, child;\r\n    if (args.length == 2) {\r\n      [id, child] = args;\r\n    } else {\r\n      child = args[0];\r\n      id = unison.nextId();\r\n    }\r\n\r\n    // sanity checks\r\n    let state = this.state();\r\n    expectObject(state, `Can't add child at ${this._path}`);\r\n    if (state[id] !== undefined) {\r\n      throw new Error(`Can't add child '${id}' at ${this._path} - it already exists.`);\r\n    }\r\n\r\n    // add it\r\n    state[id] = child;\r\n\r\n    // trigger events\r\n    let childPath = [this._path, id].join(\".\");\r\n    unison._events.triggerAll(unison.collectEvents(childPath, 'created', 'childAdded'));\r\n\r\n    // return the path to the newly created child\r\n    return childPath;\r\n  }\r\n\r\n  remove(id) {\r\n    let unison = this._unison;\r\n    let state = this.state();\r\n\r\n    // sanity checks\r\n    expectObject(state, `Can't remove child at ${this._path}`);\r\n\r\n    // does it even exist?\r\n    if (state[id] === undefined) {\r\n      return false;\r\n    }\r\n\r\n    // store events for later, as the object themselves will disappear\r\n    let childPath = [this._path, id].join(\".\");\r\n    var events = unison.collectEvents(childPath, \"destroyed\", \"childRemoved\");\r\n\r\n    // remove the object\r\n    delete state[id];\r\n\r\n    // trigger the events\r\n    unison._events.triggerAll(events);\r\n\r\n    // done\r\n    return true;\r\n  }\r\n\r\n  destroy() {\r\n    // straightforward translation\r\n    expectObject(this.state(), \"Can't destroy ${this._path}\");\r\n    return this.parent().remove(this.id());\r\n  }\r\n\r\n  on(event, callback) {\r\n    this._unison._events.listen(this._path, event, callback);\r\n  }\r\n\r\n  off(event, callback) {\r\n    this._unison._events.unlisten(this._path, event, callback);\r\n  }\r\n}\r\n\r\nfunction expectObject(state, msg) {\r\n  if (state === undefined) {\r\n    throw new Error(`${msg} - node does not exist.`)\r\n  }\r\n  if (typeof state != 'object') {\r\n    throw new Error(`${msg} - '${state}' is not an object.`);\r\n  }\r\n}\r\n\r\nfunction idFromPath(path) {\r\n  if (path === '') {\r\n    throw new Error('The root object has no id.');\r\n  } else {\r\n    return _.last(path.split(\".\"));\r\n  }\r\n}\r\n\r\nfunction parentPath(path) {\r\n  if (path === '') {\r\n    throw new Error('The root object has no parent.');\r\n  } else {\r\n    let pathElements = path.split(\".\");\r\n    return pathElements\r\n      .slice(0, pathElements.length-1)\r\n      .join(\".\");\r\n  }\r\n}"],"sourceRoot":"../../lib"}