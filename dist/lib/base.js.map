{"version":3,"sources":["base.js"],"names":[],"mappings":";;;;;;;AAOwB,MAAM,yQALkB,QAAQ,wBAC/B,UAAU;;+CAHnC,IAAI,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,AAOX,SAAS,MAAM,GAAoB,KAAnB,YAAY,yDAAG,EAAE,gBAC9C,IAAI,CAAC,MAAM,GAAG,YAAY,CAAC,AAC3B,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;;AAEjB,MAAI,CAAC,OAAO,GAAG,yBAAkB,CAAC;;;AAGlC,MAAI,CAAC,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;AACrD,MAAI,CAAC,SAAS,GAAG,UAAS,MAAM,EAAE,IAAI,EAAE;AACtC,cAAU,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC,CAAC,CACxC,CAAC;;AACF,MAAI,CAAC,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,CAC3C;;AACD,MAAM,CAAC,SAAS,GAAG;AACjB,MAAI,EAAA,cAAC,IAAI,EAAE;AACT,QAAI,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC;AAC1B,WAAO,IAAI,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAC7B;;;AAED,QAAM,EAAA,kBAAU,mCAAN,IAAI,gDAAJ,IAAI,0BAAI,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC,CAAE;AACzE,UAAQ,EAAA,oBAAU,oCAAN,IAAI,qDAAJ,IAAI,4BAAI,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC,CAAE;;AAE7E,eAAa,EAAA,uBAAC,IAAI,EAAE,WAAW,EAAY,sBAAV,GAAG,yDAAG,EAAE;AACvC,QAAI,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;;AAEtC,OAAG,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC,CAAC;AAC9B,KAAC,CAAC,IAAI,CAAC,MAAM,EAAE,UAAC,KAAK,EAAE,EAAE,EAAK;AAC5B,UAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,EAAE,KAAK,YAAY,KAAK,CAAA,AAAC,EAAE;;AAE1D,cAAK,aAAa,CAAC,UAlCnB,SAAS,EAkCoB,IAAI,EAAE,EAAE,CAAC,EAAE,WAAW,EAAE,GAAG,CAAC,CAAC,CAC3D,CACF,CAAC,CAAC;;;;AAEH,WAAO,GAAG,CAAC,CACZ;;;AAED,QAAM,EAAA,kBAAG;AACP,WAAO,CAAC,IAAI,CAAC,OAAO,GAAE,CAAE,QAAQ,EAAE,CAAC,CACpC;;;AAED,0BAAwB,EAAA,kCAAC,KAAK,EAAE;AAC9B,KAAC,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CACvB;;;AAED,wBAAsB,EAAA,gCAAC,KAAK,EAAE;AAC5B,KAAC,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC,CACjC;;;AAED,QAAM,EAAA,gBAAC,QAAQ,EAAE;AACf,QAAI,SAAS,GAAG,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;AACrC,QAAI,CAAC,wBAAwB,CAAC,SAAS,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC;AACvD,QAAI,CAAC,sBAAsB,CAAC,SAAS,CAAC,WAAW,IAAI,EAAE,CAAC,CAAC;;AAEzD,WAAO,IAAI,CAAC,CACb,EACF,CAAC;;;;AAEI,UAAU;AACH,WADP,UAAU,CACF,MAAM,EAAE,IAAI,EAAE,uBADtB,UAAU;AAEZ,QAAI,CAAC,CAAC,GAAG,MAAM,CAAC;AAChB,QAAI,CAAC,KAAK,GAAG,IAAI,CAAC,CACnB,aAJG,UAAU;;;AAMV,oBAAG;AACL,aAAO,IAAI,CAAC,KAAK,CAAC,CACnB;;;AAEC,kBAAG;AACH,aAAO,UAzEoB,UAAU,EAyEnB,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,CAChC;;;AAEK,sBAAG;AACP,aAAO,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,UA7EJ,UAAU,EA6EK,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAC7C;;;AAEI,mBAAC,EAAE,EAAE;AACR,aAAO,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,UAjFf,SAAS,EAiFgB,IAAI,CAAC,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC,CAChD;;;AAEI,qBAAG;AACN,UAAI,IAAI,CAAC,KAAK,KAAK,EAAE,EAAE;AACrB,eAAO,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,CACtB;AAAM;AACL,eAAO,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,CACzC,CACF;;;;;;;;AAMK,oBAAC,KAAK,EAAE;AACZ,UAAI,KAAK,GAAG,IAAI,CAAC,KAAK,EAAE,CAAC;AACzB,UAAI,KAAK,KAAK,SAAS,EAAE,OAAO;;AAEhC,OAAC,CAAC,MAAM,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;AACvB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC,CAC/C;;;AAEE,mBAAU;AACX,UAAI,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC;;;AAGpB,UAAI,EAAE,YAAA,EAAE,KAAK,YAAA,CAAC,mCAJT,IAAI,qDAAJ,IAAI;AAKT,UAAI,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;AACnB,UAAE,GAAW,IAAI,IAAb,KAAK,GAAI,IAAI,KACnB;AAAM;AACL,aAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;AAChB,UAAE,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC,CACtB;;;;AAGD,UAAI,KAAK,GAAG,IAAI,CAAC,KAAK,EAAE,CAAC;AACzB,kBAAY,CAAC,KAAK,2BAAwB,IAAI,CAAC,KAAK,CAAG,CAAC;AACxD,UAAI,KAAK,CAAC,EAAE,CAAC,KAAK,SAAS,EAAE;AAC3B,cAAM,IAAI,KAAK,yBAAqB,EAAE,cAAQ,IAAI,CAAC,KAAK,2BAAwB,CAAC,CAClF;;AACD,gBAAU,CAAC,EAAE,CAAC,CAAC;;;AAGf,WAAK,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC;;;AAGlB,UAAI,WAAW,GAAG,UAhId,SAAS,EAgIe,IAAI,CAAC,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC;AAC7C,YAAM,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,WAAW,EAAE,SAAS,CAAC,CAAC,CAAC;;;AAGxE,aAAO,WAAW,CAAC,CACpB;;;AAEK,oBAAC,EAAE,EAAE;AACT,UAAI,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC;AACpB,UAAI,KAAK,GAAG,IAAI,CAAC,KAAK,EAAE,CAAC;;;AAGzB,kBAAY,CAAC,KAAK,8BAA2B,IAAI,CAAC,KAAK,CAAG,CAAC;;;AAG3D,UAAI,KAAK,CAAC,EAAE,CAAC,KAAK,SAAS,EAAE;AAC3B,eAAO,KAAK,CAAC,CACd;;;;AAGD,UAAI,WAAW,GAAG,UApJd,SAAS,EAoJe,IAAI,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;AAC5C,UAAI,MAAM,GAAG,MAAM,CAAC,aAAa,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;;;AAG5D,aAAO,KAAK,CAAC,EAAE,CAAC,CAAC;;;AAGjB,YAAM,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;;;AAGlC,aAAO,IAAI,CAAC,CACb;;;AAEM,uBAAG;;AAER,kBAAY,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,6BAA6B,CAAC,CAAC;AAC1D,aAAO,IAAI,CAAC,MAAM,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,EAAE,CAAC,CAAC,CACxC;;;AAEC,gBAAC,KAAK,EAAE,QAAQ,EAAE;AAClB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACpD;;;AAEE,iBAAC,KAAK,EAAE,QAAQ,EAAE;AACnB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACtD;;;AAEI,mBAAC,KAAK,EAAE,QAAQ,EAAE;AACrB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,UAhLlB,SAAS,EAgLmB,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACrE;;;AAEK,oBAAC,KAAK,EAAE,QAAQ,EAAE;AACtB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,UApLpB,SAAS,EAoLqB,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACvE;;;AAEM,qBAAC,KAAK,EAAE,QAAQ,EAAE;AACvB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,UAxLlB,SAAS,EAwLmB,IAAI,CAAC,KAAK,EAAE,GAAG,CAAC,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACpE;;;AAEO,sBAAC,KAAK,EAAE,QAAQ,EAAE;AACxB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,UA5LpB,SAAS,EA4LqB,IAAI,CAAC,KAAK,EAAE,GAAG,CAAC,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CACtE;;;AAEM,qBAAC,KAAK,EAAE,OAAO,EAAE;AACtB,UAAI,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC,CACpD,uBArGM,eAAG,CACR,OAAO,IAAI,CAAC,KAAK,EAAE,CAAC,CACrB,YAhCG,UAAU;;;;AAsIhB,SAAS,YAAY,CAAC,KAAK,EAAE,GAAG,EAAE;AAChC,MAAI,KAAK,KAAK,SAAS,EAAE;AACvB,UAAM,IAAI,KAAK,CAAI,GAAG,6BAA0B,CAAA,CACjD;;AACD,MAAI,OAAO,KAAK,IAAI,QAAQ,EAAE;AAC5B,UAAM,IAAI,KAAK,CAAI,GAAG,aAAO,KAAK,0BAAsB,CAAC,CAC1D,CACF;;;;AAED,SAAS,UAAU,CAAC,EAAE,EAAE;AACtB,MAAI,EAAE,IAAI,EAAE,EAAE,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;AAC3D,MAAI,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,MAAM,IAAI,KAAK,CAAC,0BAA0B,CAAC,CAAC,CACvE","file":"base.js","sourcesContent":["let _ = require('lodash');\n\nimport {childPath, parentPath, idFromPath} from './util';\nimport UnisonEvents from './events';\n\n// Main Unison object.\n// Uses classical instead of ES6 classes to allow Unison.apply(...) down the road.\nexport default function Unison(initialState = {}) {\n  this._state = initialState;\n  this._nextId = 1;\n\n  this._events = new UnisonEvents();\n\n  // each Unison object has its own pseudo-class for nodes that can be extended by plugins\n  this._nodeBase = Object.create(UnisonNode.prototype);\n  this._makeNode = function(unison, path) {\n    UnisonNode.apply(this, [unison, path]);\n  };\n  this._makeNode.prototype = this._nodeBase;\n}\nUnison.prototype = {\n  grab(path) {\n    let Node = this._makeNode;\n    return new Node(this, path);\n  },\n\n  listen(...args) { return this._events.listen.apply(this._events, args); },\n  unlisten(...args) { return this._events.unlisten.apply(this._events, args); },\n\n  collectEvents(path, directEvent, acc = []) {\n    let object = _.get(this._state, path);\n\n    acc.push([path, directEvent]);\n    _.each(object, (child, id) => {\n      if (typeof child === 'object' && !(child instanceof Array)) {\n        // that's a child, trigger childAdded and recurse into it\n        this.collectEvents(childPath(path, id), directEvent, acc);\n      }\n    });\n\n    return acc;\n  },\n\n  nextId() {\n    return (this._nextId++).toString();\n  },\n\n  registerGlobalProperties(props) {\n    _.extend(this, props);\n  },\n\n  registerNodeProperties(props) {\n    _.extend(this._nodeBase, props);\n  },\n\n  plugin(pluginFn) {\n    var additions = pluginFn(this) || {};\n    this.registerGlobalProperties(additions.methods || {});\n    this.registerNodeProperties(additions.nodeMethods || {});\n\n    return this;\n  }\n};\n\nclass UnisonNode {\n  constructor(unison, path) {\n    this.u = unison;\n    this._path = path;\n  }\n\n  path() {\n    return this._path;\n  }\n\n  id() {\n    return idFromPath(this.path());\n  }\n\n  parent() {\n    return this.u.grab(parentPath(this.path()));\n  }\n\n  child(id) {\n    return this.u.grab(childPath(this.path(), id));\n  }\n\n  state() {\n    if (this._path === '') {\n      return this.u._state;\n    } else {\n      return _.get(this.u._state, this._path);\n    }\n  }\n\n  get get() {\n    return this.state();\n  }\n\n  update(props) {\n    var state = this.state();\n    if (state === undefined) return;\n\n    _.extend(state, props);\n    this.u._events.trigger(this._path, 'updated');\n  }\n\n  add(...args) {\n    let unison = this.u;\n\n    // extract arguments (either (child) or (id, child))\n    let id, child;\n    if (args.length == 2) {\n      [id, child] = args;\n    } else {\n      child = args[0];\n      id = unison.nextId();\n    }\n\n    // sanity checks\n    let state = this.state();\n    expectObject(state, `Can't add child at ${this._path}`);\n    if (state[id] !== undefined) {\n      throw new Error(`Can't add child '${id}' at ${this._path} - it already exists.`);\n    }\n    validateId(id);\n\n    // add it\n    state[id] = child;\n\n    // trigger events\n    let pathToChild = childPath(this.path(), id);\n    unison._events.triggerAll(unison.collectEvents(pathToChild, 'created'));\n\n    // return the path to the newly created child\n    return pathToChild;\n  }\n\n  remove(id) {\n    let unison = this.u;\n    let state = this.state();\n\n    // sanity checks\n    expectObject(state, `Can't remove child at ${this._path}`);\n\n    // does it even exist?\n    if (state[id] === undefined) {\n      return false;\n    }\n\n    // store events for later, as the object themselves will disappear\n    let pathToChild = childPath(this._path, id);\n    var events = unison.collectEvents(pathToChild, 'destroyed');\n\n    // remove the object\n    delete state[id];\n\n    // trigger the events\n    unison._events.triggerAll(events);\n\n    // done\n    return true;\n  }\n\n  destroy() {\n    // straightforward translation\n    expectObject(this.state(), \"Can't destroy ${this._path}\");\n    return this.parent().remove(this.id());\n  }\n\n  on(event, callback) {\n    this.u._events.listen(this._path, event, callback);\n  }\n\n  off(event, callback) {\n    this.u._events.unlisten(this._path, event, callback);\n  }\n\n  onAny(event, callback) {\n    this.u._events.listen(childPath(this._path, '**'), event, callback);\n  }\n\n  offAny(event, callback) {\n    this.u._events.unlisten(childPath(this._path, '**'), event, callback);\n  }\n\n  onChild(event, callback) {\n    this.u._events.listen(childPath(this._path, '*'), event, callback);\n  }\n\n  offChild(event, callback) {\n    this.u._events.unlisten(childPath(this._path, '*'), event, callback);\n  }\n\n  trigger(event, payload) {\n    this.u._events.trigger(this._path, event, payload);\n  }\n}\n\nfunction expectObject(state, msg) {\n  if (state === undefined) {\n    throw new Error(`${msg} - node does not exist.`)\n  }\n  if (typeof state != 'object') {\n    throw new Error(`${msg} - '${state}' is not an object.`);\n  }\n}\n\nfunction validateId(id) {\n  if (id == '') throw new Error('IDs have to be non-empty.');\n  if (id.indexOf(\".\") >= 0) throw new Error('IDs cannot contain dots.');\n}"],"sourceRoot":"../../lib"}