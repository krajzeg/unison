{"version":3,"sources":["plugins/client-server-base.js"],"names":[],"mappings":"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","file":"plugins/client-server-base.js","sourcesContent":["let _ = require('lodash');\nimport { isObject } from '../util';\n\nexport const COMMAND = 'c', INTENT = 'i', RESPONSE = 'r';\nexport const RESPONSE_OK = 'ok', RESPONSE_ERROR = 'err';\n\nconst ACCEPTABLE_MESSAGE_TYPES = [COMMAND, INTENT, RESPONSE];\nconst ACCEPTABLE_MESSAGE_LENGTHS = {\n  [COMMAND]: 4,\n  [INTENT]: 5,\n  [RESPONSE]: 4\n};\n\nexport const BUILTIN_COMMANDS = {\n  _seed(state) {\n    // we have to do this through .update() and .add() to trigger events properly\n    let children = _.pick(state, isObject);\n    let props = _.pick(state, _.negate(isObject));\n\n    // set all properties\n    this.update(props);\n\n    // add all children\n    _.each(children, (child, id) => {\n      this.add(id, child);\n    });\n  }\n};\n\nexport function serializeAll(args) {\n  return args.map((arg) => serialize(arg));\n}\n\nexport function deserializeAll(u, args) {\n  return args.map((arg) => deserialize(u, arg));\n}\n\nexport function serialize(obj) {\n  if (obj && obj.u && obj._path) {\n    return {_u: obj.path()};\n  } else {\n    return obj;\n  }\n}\n\nexport function deserialize(u, obj) {\n  if (obj && isObject(obj) && (obj._u !== undefined)) {\n    return u(obj._u);\n  } else {\n    return obj;\n  }\n}\n\nexport function parseMessage(msgString, callback) {\n  // parse the message\n  let message;\n  try {\n    message = JSON.parse(msgString);\n    let valid = messageValid(message);\n    if (!valid)\n      throw new Error('Incorrect message format.');\n  } catch(e) {\n    console.error(`Received garbage message: '${msgString}'.`);\n    console.error(e);\n    return;\n  }\n\n  // try to act upon it\n  try {\n    return callback(message);\n  } catch(e) {\n    console.error(`Problem encountered when handling message '${msgString}':`);\n    console.error(e.stack || e);\n  }\n}\n\nfunction messageValid(message) {\n  if (!(message instanceof Array)) return false;\n\n  let type = message[0];\n  if (ACCEPTABLE_MESSAGE_TYPES.indexOf(type) < 0) return false;\n  if (message.length != ACCEPTABLE_MESSAGE_LENGTHS[type]) return false;\n\n  return true;\n}\n"],"sourceRoot":"../../../lib"}