{"version":3,"sources":["plugins/client.js"],"names":[],"mappings":"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","file":"plugins/client.js","sourcesContent":["var _ = require('lodash');\r\n\r\nimport {COMMAND, INTENT, parseMessage, BUILTIN_COMMANDS} from \"./client-server-base\";\r\n\r\nexport default function client(options) {\r\n  let clientPlugin = new ClientPlugin(options);\r\n  return function(...args) {\r\n    return clientPlugin.applyPlugin.apply(clientPlugin, args);\r\n  }\r\n}\r\n\r\nclass ClientPlugin {\r\n  constructor({communication, intents = {}, commands = {}}) {\r\n    _.extend(this, {communication, intents, commands});\r\n\r\n    _.extend(this.commands, BUILTIN_COMMANDS);\r\n    this.communication.onReceive((msg) => this.receive(msg));\r\n  }\r\n\r\n  // Send a message over the provided 'communication' object.\r\n  send(message) {\r\n    let msgString = JSON.stringify(message);\r\n    this.communication.send(msgString);\r\n  }\r\n\r\n  // Called whenever a message is receive on the 'communication' object, will execute\r\n  // commands receive from the server in response.\r\n  receive(msgString) {\r\n    parseMessage(msgString, (message) => {\r\n      let [messageType] = message;\r\n      switch(messageType) {\r\n        case COMMAND:\r\n          return this.applyCommand(message);\r\n        case INTENT:\r\n          throw new Error(\"Intents should not be sent to clients.\")\r\n      }\r\n    });\r\n  }\r\n\r\n  // This method is called (indirectly) by $$.plugin(client).\r\n  applyPlugin($$) {\r\n    this.$$ = $$;\r\n    return {\r\n      nodeMethods: this.generateIntentSendingMethods()\r\n    };\r\n  }\r\n\r\n  // Generates a map of methods that will send named intents when called.\r\n  generateIntentSendingMethods() {\r\n    return _.object(_.map(this.intents,\r\n      (intentCode, intentName) => [intentName, this.makeIntentMethod(intentName)]\r\n    ));\r\n  }\r\n\r\n  // Generates a single method that will send a named intent with the right parameters when called.\r\n  makeIntentMethod(intentName) {\r\n    let client = this;\r\n    return function(...parameters) {\r\n      // this here will be the node we're called upon\r\n      let intent = [INTENT, intentName, this.path(), parameters];\r\n      client.send(intent);\r\n    }\r\n  }\r\n\r\n  // Applies a command received from the server to the local state.\r\n  applyCommand([code, commandName, objectPath, parameters]) {\r\n    // find the right one\r\n    let command = this.commands[commandName];\r\n    if (!command)\r\n      throw new Error(`Received unknown command: '${commandName}'.`);\r\n\r\n    let $$ = this.$$;\r\n    let target = $$(objectPath);\r\n\r\n    return command.apply(target, parameters);\r\n  }\r\n}\r\n\r\n/*\r\n intent:\r\n function moveMagnet(clientId, $$magnet, newPosition) {\r\n $$magnet.moveTo(newPosition);\r\n }\r\n\r\n command:\r\n function moveTo($$magnet, newPosition) {\r\n $$magnet.update({x: newPosition.x, y: newPosition.y});\r\n }\r\n\r\n tryMovingMagnet(clientId, newPosition) {\r\n  this.command.moveTo(newPosition);\r\n }\r\n moveMagnetTo(newPosition) {\r\n  this.update({x: newPosition.x, y: newPosition.y})\r\n }\r\n\r\nmagnet.intent.move({x: 12, y: 44});\r\n */\r\n\r\n\r\n/*\r\n\r\n COMMUNICATION LOGIC:\r\n client - intent method:   send [object, intent, parameters] to the server\r\n client - command method:  < not present >\r\n client - apply intent:    < not present >\r\n client - apply command:   execute the code\r\n\r\n server - intent method:   virtual send [object, intent, parameters] to yourself\r\n server - apply intent:    execute the code, calling one or more command method or rejecting the intent\r\n server - command method:  execute the code, send [object, command, parameters] to all clients\r\n server - apply command:   < not present >\r\n\r\n intent code - runs on the server, translates intent into commands\r\n command code - runs on both, applies changes to state\r\n */\r\n"],"sourceRoot":"..\\..\\..\\lib"}