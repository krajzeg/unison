{"version":3,"sources":["plugins/client.js"],"names":[],"mappings":"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","file":"plugins/client.js","sourcesContent":["var _ = require('lodash');\n\nimport {COMMAND, INTENT, parseMessage, BUILTIN_COMMANDS} from \"./client-server-base\";\n\nexport default function client(options) {\n  let clientPlugin = new ClientPlugin(options);\n  return function(...args) {\n    return clientPlugin.applyPlugin.apply(clientPlugin, args);\n  }\n}\n\nclass ClientPlugin {\n  constructor({communication, intents = {}, commands = {}}) {\n    _.extend(this, {communication, intents, commands});\n\n    _.extend(this.commands, BUILTIN_COMMANDS);\n    this.communication.onReceive((msg) => this.receive(msg));\n  }\n\n  // Send a message over the provided 'communication' object.\n  send(message) {\n    let msgString = JSON.stringify(message);\n    this.communication.send(msgString);\n  }\n\n  // Called whenever a message is receive on the 'communication' object, will execute\n  // commands receive from the server in response.\n  receive(msgString) {\n    parseMessage(msgString, (message) => {\n      let [messageType] = message;\n      switch(messageType) {\n        case COMMAND:\n          return this.applyCommand(message);\n        case INTENT:\n          throw new Error(\"Intents should not be sent to clients.\")\n      }\n    });\n  }\n\n  // This method is called (indirectly) by $$.plugin(client).\n  applyPlugin($$) {\n    this.$$ = $$;\n    return {\n      nodeMethods: this.generateIntentSendingMethods()\n    };\n  }\n\n  // Generates a map of methods that will send named intents when called.\n  generateIntentSendingMethods() {\n    return _.object(_.map(this.intents,\n      (intentCode, intentName) => [intentName, this.makeIntentMethod(intentName)]\n    ));\n  }\n\n  // Generates a single method that will send a named intent with the right parameters when called.\n  makeIntentMethod(intentName) {\n    let client = this;\n    return function(...parameters) {\n      // this here will be the node we're called upon\n      let intent = [INTENT, intentName, this.path(), parameters];\n      client.send(intent);\n    }\n  }\n\n  // Applies a command received from the server to the local state.\n  applyCommand([code, commandName, objectPath, parameters]) {\n    // find the right one\n    let command = this.commands[commandName];\n    if (!command)\n      throw new Error(`Received unknown command: '${commandName}'.`);\n\n    let $$ = this.$$;\n    let target = $$(objectPath);\n\n    return command.apply(target, parameters);\n  }\n}\n\n/*\n intent:\n function moveMagnet(clientId, $$magnet, newPosition) {\n $$magnet.moveTo(newPosition);\n }\n\n command:\n function moveTo($$magnet, newPosition) {\n $$magnet.update({x: newPosition.x, y: newPosition.y});\n }\n\n tryMovingMagnet(clientId, newPosition) {\n  this.command.moveTo(newPosition);\n }\n moveMagnetTo(newPosition) {\n  this.update({x: newPosition.x, y: newPosition.y})\n }\n\nmagnet.intent.move({x: 12, y: 44});\n */\n\n\n/*\n\n COMMUNICATION LOGIC:\n client - intent method:   send [object, intent, parameters] to the server\n client - command method:  < not present >\n client - apply intent:    < not present >\n client - apply command:   execute the code\n\n server - intent method:   virtual send [object, intent, parameters] to yourself\n server - apply intent:    execute the code, calling one or more command method or rejecting the intent\n server - command method:  execute the code, send [object, command, parameters] to all clients\n server - apply command:   < not present >\n\n intent code - runs on the server, translates intent into commands\n command code - runs on both, applies changes to state\n */\n"],"sourceRoot":"../../../lib"}