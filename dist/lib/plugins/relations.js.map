{"version":3,"sources":["plugins/relations.js"],"names":[],"mappings":"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","file":"plugins/relations.js","sourcesContent":["let _ = require('lodash');\n\nexport default function relations(rels) {\n  let plugin = new Relations(rels)\n  return (u) => (plugin.applyPlugin(u));\n}\n\nclass Relations {\n  constructor(relations) {\n    this.relatives = {}\n\n    _.each(relations, (rel) => {\n      this.relatives[rel.AtoB] = rel;\n      this.relatives[rel.BtoA] = rel;\n    });\n  }\n\n  find(name) {\n    let rel = this.relatives[name];\n    if (!rel)\n      throw new Error(`Unknown relation name: '$rel'`);\n    return rel;\n  }\n\n  findInverse(name) {\n    let rel = this.find(name);\n    return (rel.AtoB == name) ? rel.BtoA : rel.AtoB;\n  }\n\n  // Returns 'true' if the object can only be in this relation with one other object (e.g. \"is located in\")\n  isSingular(name) {\n    let rel = this.find(name);\n    return !!(((rel.AtoB == name) && rel.B) || ((rel.BtoA == name) && rel.A));\n  }\n\n  applyPlugin(u) {\n    this.u = u;\n\n    // add the core 'relate' and 'cease' commands (or methods if not in a client/server environment)\n    let commands = {}, addCommand;\n\n    if (u.addCommand) {\n      addCommand = u.addCommand.bind(u);\n    } else {\n      addCommand = function(name, fn) { commands[name] = fn; };\n    }\n    addCommand('now', makeRelateFn(this));\n    addCommand('noLonger', makeCeaseFn(this));\n\n    // add all relation predicates\n    let relationNames = _.keys(this.relatives);\n    let predicates = _.object(_.map(relationNames, (name) => [name, makeCheckFn(name)]));\n\n    // add all relation getter methods\n    let getters = {};\n    _.each(this.relatives, (rel) => {\n      if (rel.A) getters[rel.A] = makeSingleGetter(rel.BtoA);\n      if (rel.B) getters[rel.B] = makeSingleGetter(rel.AtoB);\n      if (rel.As) getters[rel.As] = makeMultipleGetter(rel.BtoA);\n      if (rel.Bs) getters[rel.Bs] = makeMultipleGetter(rel.AtoB);\n    });\n\n    // done!\n    return {\n      nodeMethods: _.extend(commands, predicates, getters)\n    };\n  }\n}\n\nfunction makeRelateFn(relations) {\n  return function(name, otherSide) {\n    addRelation(relations, this, name, otherSide, relations.isSingular(name));\n\n    let inverse = relations.findInverse(name);\n    addRelation(relations, otherSide, inverse, this, relations.isSingular(inverse));\n  };\n}\n\nfunction makeCeaseFn(relations) {\n  return function(name, otherSide) {\n    removeRelation(relations, this, name, otherSide);\n    removeRelation(relations, otherSide, relations.findInverse(name), this);\n  }\n}\n\nfunction makeCheckFn(relationName) {\n  return function(otherSide) {\n    let path = otherSide.path();\n    let rels = this.get[relationName] || [];\n    return rels.indexOf(path) >= 0;\n  }\n}\n\nfunction makeSingleGetter(relationName) {\n  return function() {\n    let rels = this.get[relationName];\n    let time = this.timestamp();\n    if (rels && rels.length > 0)\n      return this.u(_.first(rels), time);\n    else\n      return undefined;\n  }\n}\n\nfunction makeMultipleGetter(relationName) {\n  return function() {\n    let rels = this.get[relationName] || [];\n    let time = this.timestamp();\n    return _.map(rels, (path) => this.u(path, time));\n  }\n}\n\nfunction addRelation(relations, fromObj, name, toObj, removePreviousRelations = false) {\n  let u = fromObj.u, toPath = toObj.path();\n\n  let currentRels = fromObj.get[name] || [];\n  if (_.contains(currentRels, toPath))\n    throw new Error(`Relation '${fromObj.path()} ${name} ${toPath}' already exists.`);\n\n  if (removePreviousRelations && currentRels.length) {\n    let inverse = relations.findInverse(name);\n    _.each(currentRels, (path) => {\n      removeRelation(relations, u(path), inverse, fromObj);\n    });\n    currentRels = [];\n  }\n\n  let updatedRels = currentRels.concat([toObj.path()]);\n\n  fromObj.update({[name]: updatedRels});\n  fromObj.trigger('now:' + name, {target: toObj});\n}\n\nfunction removeRelation(relations, fromObj, name, toObj) {\n  let toPath = toObj.path();\n\n  let rels = fromObj.get[name] || [];\n  if (!_.contains(rels, toPath))\n    throw new Error(`Relation '${fromObj.path()} ${name} ${toPath}' can't be removed, because it doesn't exist.`);\n\n  fromObj.update({[name]: _.without(rels, toPath)});\n  fromObj.trigger('noLonger:' + name, {target: toObj});\n}\n"],"sourceRoot":"../../../lib"}