{"version":3,"sources":["plugins/relations.js"],"names":[],"mappings":"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","file":"plugins/relations.js","sourcesContent":["let _ = require('lodash');\nimport { functionized } from '../util';\n\nexport default function relations() {\n  return functionized(RelationsPlugin, [], 'applyPlugin');\n}\n\nfunction RelationsPlugin() {\n  // nothing to initialize\n}\nRelationsPlugin.prototype = {\n  applyPlugin(u) {\n    this.u = u;\n\n    // add the core 'relate' and 'cease' commands (or methods if not in a client/server environment)\n    let fallbackMethods = {};\n    if (u.serverSide || u.clientSide) {\n      u.define({\n        commands: {\n          now: relateWith,\n          noLonger: ceaseRelationWith\n        }\n      });\n    } else {\n      fallbackMethods = {\n        now: relateWith,\n        noLonger: ceaseRelationWith\n      }\n    }\n\n    // done!\n    return {\n      nodeMethods: fallbackMethods,\n      onDefine: this.processDefinitions.bind(this)\n    };\n  },\n\n  processDefinitions(typeName, defs, prototype) {\n    let u = this.u, rels = defs.relations || {};\n\n    _.each(rels, (rel) => {\n      rel.withType = rel.withType || 'Node';\n      let aType = u.type(typeName), bType = u.type(rel.withType);\n      let aProto = prototype, bProto = bType.proto;\n\n      // add predicates\n      aProto[rel.AtoB] = makeCheckFn(rel.AtoB);\n      bProto[rel.BtoA] = makeCheckFn(rel.BtoA);\n\n      // add getters\n      if (rel.B) aProto[rel.B] = makeSingleGetter(rel.AtoB);\n      if (rel.Bs) aProto[rel.Bs] = makeMultipleGetter(rel.AtoB);\n      if (rel.A) bProto[rel.A] = makeSingleGetter(rel.BtoA);\n      if (rel.As) bProto[rel.As] = makeMultipleGetter(rel.BtoA);\n\n      // register relations for easy lookup\n      if (!aType.relations) aType.relations = {};\n      if (!bType.relations) bType.relations = {};\n\n      let aRels = aType.relations, bRels = bType.relations || {};\n      let inverseRel = {withType: typeName, AtoB: rel.BtoA, BtoA: rel.AtoB, A: rel.B, B: rel.A, As: rel.Bs, Bs: rel.As};\n      aRels[rel.AtoB] = rel; bRels[rel.BtoA] = inverseRel;\n    });\n  }\n};\n\nfunction findRelation(node, relationName) {\n  let type = node.type();\n  while (type) {\n    if (type.relations && type.relations[relationName])\n      return type.relations[relationName];\n    type = type.extend;\n  }\n\n  throw new Error(`${node.type().name} objects cannot enter into relations named '${relationName}'.`);\n}\n\nfunction relateWith(name, otherSide) {\n  let rel = findRelation(this, name);\n\n  let isSingularRelation = !!rel.B;\n  addRelation(this, name, otherSide, isSingularRelation);\n  let inverse = rel.BtoA, isInverseSingular = rel.A;\n  addRelation(otherSide, inverse, this, isInverseSingular);\n}\n\nfunction ceaseRelationWith(name, otherSide) {\n  let rel = findRelation(this, name);\n\n  removeRelation(this, name, otherSide);\n  removeRelation(otherSide, rel.BtoA, this);\n}\n\nfunction addRelation(fromObj, name, toObj, removePreviousRelations = false) {\n  let u = fromObj.u, toPath = toObj.path();\n\n  let fromType = fromObj.type(), toType = toObj.type();\n  let rel = findRelation(fromObj, name);\n  if (!toObj.isA(rel.withType))\n    throw new Error(`${fromType.name} objects enter '${name}' relations only with ${rel.withType} objects.`);\n\n  let currentRels = fromObj.get[name] || [];\n  if (_.contains(currentRels, toPath))\n    throw new Error(`Relation '${fromObj.path()} ${name} ${toPath}' already exists.`);\n\n  if (removePreviousRelations && currentRels.length) {\n    let inverse = rel.BtoA;\n    _.each(currentRels, (path) => {\n      removeRelation(u(path), inverse, fromObj);\n    });\n    currentRels = [];\n  }\n\n  let updatedRels = currentRels.concat([toObj.path()]);\n\n  fromObj.update({[name]: updatedRels});\n  fromObj.trigger('now:' + name, {target: toObj});\n}\n\nfunction removeRelation(fromObj, name, toObj) {\n  let toPath = toObj.path();\n\n  let rels = fromObj.get[name] || [];\n  if (!_.contains(rels, toPath))\n    throw new Error(`Relation '${fromObj.path()} ${name} ${toPath}' can't be removed because it doesn't exist.`);\n\n  fromObj.update({[name]: _.without(rels, toPath)});\n  fromObj.trigger('noLonger:' + name, {target: toObj});\n}\n\n\nfunction makeCheckFn(relationName) {\n  return function(otherSide) {\n    let path = otherSide.path();\n    let rels = this.get[relationName] || [];\n    return rels.indexOf(path) >= 0;\n  }\n}\n\nfunction makeSingleGetter(relationName) {\n  return function() {\n    let rels = this.get[relationName];\n    let time = this.timestamp();\n    if (rels && rels.length > 0)\n      return this.u(_.first(rels), time);\n    else\n      return undefined;\n  }\n}\n\nfunction makeMultipleGetter(relationName) {\n  return function() {\n    let rels = this.get[relationName] || [];\n    let time = this.timestamp();\n    return _.map(rels, (path) => this.u(path, time));\n  }\n}\n"],"sourceRoot":"../../../lib"}