{"version":3,"sources":["events.js"],"names":[],"mappings":"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","file":"events.js","sourcesContent":["let _ = require('lodash');\n\nimport {childPath, parentPath} from './util';\n\nexport default class UnisonEvents {\n  constructor(unison) {\n    this.u = unison;\n    this._listeners = {};\n  }\n\n  key(path, event) {\n    return `${path}:${event}`;\n  }\n\n  listen(path, event, callback, options = {}) {\n    let priority = options.priority || 0;\n\n    let key = this.key(path, event);\n    let existingListeners = this._listeners[key] || [];\n    this._listeners[key] = existingListeners.concat([{callback, priority, path}]);\n  }\n\n  unlisten(path, event, callback) {\n    let key = this.key(path, event);\n    let listeners  = (this._listeners[key] || []).filter((l) => l.callback != callback);\n    if (listeners.length == 0) {\n      delete this._listeners[key];\n    } else {\n      this._listeners[key] = listeners;\n    }\n  }\n\n  executeListener(listener, eventObj) {\n    try {\n      (listener.callback)(eventObj);\n    } catch (e) {\n      console.error(`Error in listener in response to ${listener.path}|${eventObj.name}`);\n      console.error(e.stack || e);\n    }\n  }\n\n  trigger(path, event, payload = {}) {\n    let source = (this.u)(path);\n    let eventObj = new UnisonEvent(event, source, this.u.currentTime(), payload);\n\n    // gather all paths that should be considered in order\n    let paths;\n    if (path != '') {\n      paths = [path, childPath(parentPath(path), '*')]; // X.Y.Z, X.Y.*\n\n      path = childPath(path, '**'); // X.Y.Z -> X.Y.Z.**\n      paths.push(path);\n      while(path.indexOf('.') >= 0) {\n        path = childPath(parentPath(parentPath(path)), '**'); // X.Y.** -> X.**\n        paths.push(path);\n      }\n    } else {\n      paths = ['', '**'];\n    }\n\n    // grab listeners from all the paths\n    let listeners = [];\n    paths.forEach((path) => {\n      let listenersForPath = this._listeners[this.key(path, event)];\n      if (listenersForPath)\n        listeners.push(...listenersForPath);\n    });\n\n    // sort them by priority\n    listeners = _.sortBy(listeners, 'priority');\n\n    // execute them in turn\n    listeners.forEach((l) => this.executeListener(l, eventObj));\n  }\n\n  triggerAll(events) {\n    _.each(events, (event) => {\n      this.trigger.apply(this, event);\n    });\n  }\n}\n\n// Represents all events triggered from Unison and their common properties.\nclass UnisonEvent {\n  constructor(name, source, timestamp, additionalProps = {}) {\n    this.name = name;\n    this.source = source;\n    this.snapshot = source.at(timestamp);\n    this.timestamp = timestamp;\n\n    _.extend(this, additionalProps);\n  }\n}\n"],"sourceRoot":"../../lib"}